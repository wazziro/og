# `og` タスク管理ツール 仕様書 (v1.0 ドラフト)

## 序文

この仕様書は、`og` コマンドファミリーで利用されるタスクデータのJSON形式、Markdown形式、およびそれらを操作する `og` コマンドの基本的な設計指針と主要機能の仕様を定義するものです。
本仕様は、シンプルさ、ターミナル中心の操作性、Vimとの親和性、データの一貫性、そしてユーザーによる拡張性を重視し、対話を通じて構築されました。
JSONを信頼できるデータストアとしつつ、Markdownの記述・編集のしやすさを最大限に活かすことを目指します。

## A. JSON タスクデータフォーマット仕様 (NDJSON)

### A.1. 全体構造

* 各タスクは、1行の独立したJSONオブジェクトとして表現されるNDJSON (Newline Delimited JSON) 形式を基本とします。

### A.2. フィールド定義

キー名は `_at` サフィックスなしの形式（例: `created`）に統一します。

#### A.2.1. 必須キー（JSONオブジェクトにキーと値が常に存在することが期待される項目）
*(値については、元データにない場合にツールが補完・生成するものも含む)*

* **`name`**
    * **型:** `string`
    * **説明:** タスクの名称。
    * **必須性:** キー・値ともに必須。
    * **例:** `"仕様書をレビューする"`

* **`status`**
    * **型:** `string`
    * **説明:** タスクの現在の状態。
    * **必須性:** キー・値ともに必須。
    * **許容値:** `"NONE"`, `"PENDING"`, `"DOING"`, `"WAITING"`, `"DONE"`, `"CANCELLED"`, `"UNKNOWN"` のいずれか。
    * **例:** `"PENDING"`

* **`priority`**
    * **型:** `string`
    * **説明:** タスクの優先度。
    * **必須性:** キー・値ともに必須。
    * **許容値:** `"N"` (デフォルト/標準優先度)、または大文字アルファベット1文字以上で構成される文字列 (例: `"A"`, `"B"`, `"AAA"`, `"HIGH"` など)。
    * **例:** `"A"`, `"N"`

* **`id`**
    * **型:** `number`
    * **説明:** タスクの一意な識別子。処理対象ファイル内で一意となる1以上の整数。
    * **必須性:** キー・値ともに必須。
    * **補完ルール:** ツールがパースする際に、IDが存在しない場合やファイル内で重複している場合は、ファイル内の既存IDを考慮した採番ルール（1から開始、欠番優先、なければ最大値+1）で自動的に割り当てる。
    * **例:** `1`, `15`, `100`

* **`created`**
    * **型:** `string`
    * **説明:** タスクの作成日。
    * **必須性:** キー・値ともに必須。
    * **フォーマット:** `YYYY-MM-DD` 形式の文字列。
    * **補完ルール:** 元データに作成日情報がない場合、ツールが処理を実行した日の日付をこの形式で自動的に設定する（例: `"2025-05-18"`）。
    * **例:** `"2025-05-18"`

* **`display_order`**
    * **型:** `number`
    * **説明:** Markdown上での表示順序を制御するための内部的な順序値。正の整数。
    * **必須性:** キー・値ともに必須。
    * **管理方法:** MarkdownがJSONに変換・保存される際、Markdownの行順に基づいてツールが1から始まる連番を割り当てる。タスクの順序変更時には再割り当てされる。
    * **例:** `1`, `2`, `100`

#### A.2.2. キーは必須、値は `null` を許容する項目
*(これらのキーはJSONオブジェクトに常に存在しますが、対応する情報がない場合は値として `null` を持ちます)*

* **`due`**
    * **型:** `string` または `null`
    * **説明:** タスクの期日。
    * **必須性:** キーは必須。
    * **フォーマット:** 値が設定されている場合は `YYYY-MM-DD` 形式の文字列。未設定の場合は `null`。
    * **例:** `"2025-12-31"`, `null`

* **`updated`**
    * **型:** `string` または `null`
    * **説明:** タスクの最終更新日。
    * **必須性:** キーは必須。
    * **フォーマット:** 値が設定されている場合は `YYYY-MM-DD` 形式の文字列。未設定の場合は `null`。
    * **例:** `"2025-05-18"`, `null`

* **`completed`**
    * **型:** `string` または `null`
    * **説明:** タスクの完了日。`status` が `"DONE"` の場合に通常設定される。
    * **必須性:** キーは必須。
    * **フォーマット:** 値が設定されている場合は `YYYY-MM-DD` 形式の文字列。未設定の場合は `null`。
    * **補完ルール:** `status` が `"DONE"` に変更された際にツールが日付を補完する場合がある (例: 処理日の日付)。
    * **例:** `"2025-05-19"`, `null`

#### A.2.3. オプションキー (情報がない場合はキー自体を省略可能な項目)

* **`project`**
    * **型:** `string`
    * **説明:** タスクが属するプロジェクト名。
    * **必須性:** オプション。
    * **例:** `"次期システム開発"`

* **`contexts`**
    * **型:** `array of string`
    * **説明:** タスクを実行するコンテキストを示すタグのリスト。
    * **必須性:** オプション。キーが存在する場合、値は配列（空の場合は `[]`）。`null` は使用しない。
    * **例:** `["work", "meeting"]`, `[]`

* **`notes`**
    * **型:** `string`
    * **説明:** タスクに関する追加の自由記述メモ。
    * **必須性:** オプション。
    * **例:** `"関連資料は別途送付済み"`

* **`tags`**
    * **型:** `array of string`
    * **説明:** 一般的なタグのリスト。
    * **必須性:** オプション。キーが存在する場合、値は配列（空の場合は `[]`）。`null` は使用しない。
    * **例:** `["重要", "後で確認"]`

* **`subtasks`**
    * **型:** `array of Task objects` (この仕様のTaskオブジェクトに再帰的に従う)
    * **説明:** このタスクに紐づく子タスクのリスト。
    * **必須性:** オプション。キーが存在する場合、値は配列（空の場合は `[]`）。`null` は使用しない。
    * **例:** `[{"id": 101, ...}, {"id": 102, ...}]`

* **`extra`**
    * **型:** `object`
    * **説明:** 上記以外のユーザー定義の追加情報を格納するキーバリューオブジェクト。
    * **必須性:** オプション。
    * **表現:** `"extra": {"カスタムキー": "値", ...}` のように専用キーの下にネスト。追加情報がなければ `extra` キー自体を省略。
    * **例:** `{"extra": {"担当": "山田"}}`

* **`repeat`**
    * **型:** `object`
    * **説明:** タスクが繰り返しタスクであることを示す。
    * **必須性:** オプション。繰り返しタスクの場合のみ存在。
    * **値:** 初期仕様としては空オブジェクト `{}`。将来的に頻度等のルールを格納。
    * **例:** `"repeat": {}`

### A.3. 非タスク行のJSON表現
* Markdownファイル内のコメント行や非タスク行は、このJSONタスクオブジェクトの仕様には含まれず、ツール処理時に破棄されます。

---

## B. Markdown タスクフォーマット仕様

### B.1. 全体構造
* 各タスクは1行のリストアイテムとして表現されます。
* サブタスクは、親タスクに対して半角スペース4つを1レベルとしてインデントすることで表現されます。

### B.2. 基本フォーマットと属性の標準表示順序
`og fmt` コマンドが整形する際の標準的な属性の表示順序は以下の通りです。この順序は設定ファイルでユーザーが変更可能とすることを想定します。
**注意:** JSONに存在する `display_order` フィールドは、Markdown上には表示されません。Markdownの行の順序は、JSONから生成される際に `display_order` に基づいて決定されます。

タスク行の基本形（属性を含む場合）:
`- [ステータス] (優先度) [[タスク名]] id:<ID> due:<期日表現> +<プロジェクト名> @<コンテキスト名> #<一般タグ> created:<作成日> updated:<更新日表現> completed:<完了日表現> note:<メモ>`

### B.3. 要素詳細

* **`- [ステータスマーカー]`** (**必須**)
    * `- ` と `[` の間に半角スペース1つ。
    * **マーカー:** ` `(NONE), `p`(PENDING), `>`(DOING), `w`(WAITING), `x`(DONE), `c`(CANCELLED), `?`(UNKNOWN)。大文字・小文字は区別されません。

* **`(優先度文字列)`** (**必須表示** - ツールが補完)
    * ステータスマーカーの `]` との間に半角スペース1つ（存在する場合）。
    * **形式:** `(P)`。`P` は `"N"` または大文字アルファベット1文字以上。
    * **補完ルール:** `og fmt` は、優先度指定がないタスク行には `(N)` を補完。`pri:P` 属性は `(P)` に正規化。

* **`[[タスク名]]`** (**必須**)
    * 優先度文字列 `)` との間に半角スペース1つ（優先度がある場合）。ない場合はステータスマーカー `]` との間に半角スペース1つ。
    * タスク名本体を `[[` と `]]` で囲むWikiLink形式。詳細メモをそのリンク先に取る運用を想定。

### B.4. 属性ごとの表示ルール (JSON仕様と連動)
タスク名 `]]` の後、半角スペース1つを空けて属性が続きます。各属性間も半角スペース1つ。

* **`id:<ID>`**
    * **表示:** 常にキーと値を表示（ツール補完）。
    * **値:** 数値。例: `id:123`
* **`due:<期日表現>`**
    * **表示:** 常にキーを表示。
    * **値:** `YYYY-MM-DD` 形式 (例: `due:2025-12-31`)、またはJSONで `null` なら `due:""`。
* **`+<プロジェクト名>`**
    * **表示:** JSONに `project` 情報がある場合のみ表示。なければキーごと省略。例: `+projectAlpha`
* **`@<コンテキスト名>`**
    * **表示:** JSONに `contexts` 情報がある場合のみ表示（複数可、スペース区切り）。なければキーごと省略。記述順維持。例: `@work @meeting`
* **`#<一般タグ>`**
    * **表示:** JSONに `tags` 情報がある場合のみ表示（複数可、スペース区切り）。なければキーごと省略。記述順維持。例: `#idea #bug`
    * (表示順序: `@コンテキスト名` の後、`created:` の前が基本)
* **`created:<作成日>`**
    * **表示:** 常にキーと値を表示（ツール補完）。
    * **値:** `YYYY-MM-DD` 形式。例: `created:2025-05-18`
* **`updated:<更新日表現>`**
    * **表示:** 常にキーを表示。
    * **値:** `YYYY-MM-DD` 形式 (例: `updated:2025-05-18`)、またはJSONで `null` なら `updated:""`。
* **`completed:<完了日表現>`**
    * **表示:** 常にキーを表示。
    * **値:** `YYYY-MM-DD` 形式 (例: `completed:2025-05-19`)、またはJSONで `null` なら `completed:""`。
* **`note:"<メモ>"`**
    * **表示:** JSONに `notes` 情報がある場合のみ表示。値は常にダブルクォートで囲む (空のメモなら `note:""`)。なければキーごと省略。

### B.5. 日付フォーマット
* Markdownファイル上での日付の**保存・表示形式:** `YYYY-MM-DD`。
* Markdownへの**入力時に許容される形式:** `YYYY-MM-DD`, `MM/DD` (当年補完), `M/D` (当年補完), `YYYY/MM/DD` 等。ツールが解釈し、保存・表示時は `YYYY-MM-DD` に正規化。

### B.6. スペースルール・インデントルール
* **スペース:** 各構成要素間は半角スペース1つ。`og fmt` が整形。
* **インデント:** サブタスクは半角スペース4つを1レベル。`og fmt` が整形。

### B.7. 非タスク行の扱い
* `og` ツールがMarkdownファイルを処理する際、タスクとして解釈できない行（コメント、空行、見出し等）は保持されず、結果として削除されます（消えてよい）。

---

## C. `og` コマンド基本設計指針

### C.1. 基本思想
* **シンプルさ:** コマンド体系とオプションは直感的でシンプルに保つ。
* **テキストベース:** 標準入出力を活用し、パイプラインでの連携を容易にする。
* **ユーザー修正支援:** 過度な自動修正は避け、ユーザーが正しいフォーマットで作業できるよう支援する（エラー通知、整形結果の提示など）。
* **JSONを正とするアーキテクチャ:** Vim等でのMarkdown編集をサポートしつつ、JSONデータストアの一貫性を重視する。

### C.2. 入力フォーマット指定
* `og` コマンドでデータを入力として受け取る際には、常に `--from <FORMAT>` (または `-f <FORMAT>`) オプションで入力データの形式を明示的に指定する。
    * `<FORMAT>` は `json|j|markdown|m`（大文字・小文字区別なし）。
* フォーマット指定がない場合はエラーとする。ファイルの拡張子による自動判別は行わない。

### C.3. 出力フォーマット指定
* 変換処理などでは `--to <FORMAT>` (または `-t <FORMAT>`) オプションで出力データの形式を明示的に指定する。
    * `<FORMAT>` は `json|j|markdown|m`（または将来追加される整形済みMarkdownを示す特別な値）。

### C.4. 標準入出力とファイル指定
* **入力:** デフォルトは標準入力。ファイルパスを引数として指定可能。
* **出力:** デフォルトは標準出力。`-o, --output <FILE>` オプションで出力ファイル指定可。

### C.5. エラーハンドリング
* 処理中にエラーが発生した場合は、標準エラー出力に簡潔なエラーメッセージを書き出し、非ゼロの終了ステータスを返す。

### C.6. 標準オプション
* `--help` および `--version` を提供する。

---

## D. 主要コマンド機能仕様 (初期案)

### D.1. `og` (JSONからMarkdownへの変換モード)
* **呼び出し例:** `cat tasks.json | og --from json --to markdown` または `og --from json --to markdown tasks.json [-o tasks.md]`
* **動作:** NDJSON形式のJSONデータを入力とし、セクションBで定義されたMarkdownタスクフォーマット仕様に従って整形されたMarkdownテキストを出力する。
* **専用オプション:** 初期段階ではなし。

### D.2. `og` (MarkdownからJSONへの変換モード)
* **呼び出し例:** `cat tasks.md | og --from markdown --to json` または `og --from markdown --to json tasks.md [-o tasks.json]`
* **動作:** Markdownテキストを入力とし、セクションBのMarkdown仕様に従って解析し、セクションAのJSONタスクデータ仕様に従ったNDJSON形式のJSONデータを出力する。
    * ID採番、`created`日補完、日付正規化など、JSON仕様で定義されたツール側の処理を含む。
* **専用オプション:** 初期段階ではなし。

### D.3. `og fmt` (Markdown整形コマンド)
* **呼び出し例:** `og fmt --from markdown tasks.md [-o formatted.md] [-i]`
* **目的:** Markdownタスクファイルを、セクションBで定義されたMarkdown仕様に従って整形する。
* **動作:**
    * 入力Markdownをパースし、属性順序、スペース・インデント、日付/優先度/タグ/引用符の正規化などを行う。
    * 非タスク行は破棄される。
* **オプション:**
    * `-o, --output <FILE>`: 出力ファイル指定。
    * `-i, --in-place`: 入力ファイルを直接上書き。

### D.5. `og cal` (カレンダー表示コマンド)
* **呼び出し例:** `og cal [--next]`
* **目的:** Googleカレンダーから予定を表示する。
* **動作:**
    * 指定された日付（デフォルトは今日）のカレンダー予定を取得し表示する。
    * 予定は「開始時間-終了時間 タイトル」の形式で表示される。
    * 例: `10:00-11:00 予定A`
    * Google Calendarの認証情報は `~/.config/google/credentials.json` から読み込まれる。
    * 認証情報ファイルのフォーマットは Google Cloud Platform からダウンロードできる OAuth 2.0 クライアント ID 形式に準拠する。
* **オプション:**
    * `--next`: 翌営業日（次の平日）の予定を表示する。

---

## E. Markdown編集からJSONへの変更反映ロジック (差分マージ基本方針)
*(主に `og --from markdown --to json` がVim連携などでJSONデータストアを更新する際の内部ロジック)*

1.  **タスクの同定:** `id` フィールドを使用。
2.  **フィールドの更新:** Markdownで編集可能なフィールドはJSONに値を反映。`updated` 日はツール処理日で自動更新。
3.  **新規タスクの追加:** Markdownでの新規追加は、JSON仕様に従い `id`, `created`, `display_order` を採番・設定してJSONに追加。
4.  **タスクの削除:** Markdownからタスク行が削除されたらJSONからも対応タスクを削除（確認なし）。
5.  **タスクの順序変更:** Markdownの行順変更を検出し、JSON側の全タスクの `display_order` を再採番して反映。
6.  **JSON固有情報の保護:** `extra` フィールドなど、Markdownで直接編集されないJSON側の情報は保持。
7.  **属性削除の扱い:**
    * オプションキー属性 (`project`等) がMDから削除されたら、JSONからもキーごと削除。
    * キー必須（値`null`可）属性 (`due`等) がMDからまるごと削除されたら、JSONではキーを残し値を`null`に。

---

## F. 将来的な拡張の可能性
* `repeat` フィールドの詳細なルール定義と、それに基づく繰り返しタスクの管理機能。
* より高度なタスク検索・フィルタリング・集計機能（ただし、ユーザーは`awk`等での代替を表明）。
* 他のツールとの連携インターフェース（APIなど）。
* Vim拡張機能の具体的な開発。

---
